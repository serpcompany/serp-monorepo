#!/bin/sh

# Start
echo "[husky]: Running pre-commit hook..."

# Check staged files
STAGED_FILES=$(git diff --cached --name-only)
echo "[husky]: Your staged files: $STAGED_FILES"

# Run lint-staged to lint only staged files
echo "[husky]: Running lint-staged..."
npx lint-staged

# Check if lint-staged made any changes to the working directory
echo "[husky]: Checking if lint made any changes..."
if ! git diff --exit-code; then
  echo "❌ [husky]: Lint made changes to your files!"
  echo "Please run 'pnpm lint --fix' to fix issues, then stage and commit again."
  echo "This ensures your commit includes all the formatting fixes."
  exit 1
fi
echo "✅ [husky]: No changes made by lint - proceeding..."

# Run TypeScript check for TS7006 errors (parameter implicitly has any type)
echo "[husky]: Running script: pnpm typecheck:ts7006"
pnpm typecheck:ts7006

# Run ESLint check for ts/explicit-function-return-type errors (missing return types)
echo "[husky]: Running script: pnpm lint:return-types"
pnpm lint:return-types

# Run Infisical scan on staged changes with baseline
echo "[husky]: Running command: pnpm infisical scan git-changes --staged --verbose --baseline-path .reports/secrets-report.json"
pnpm infisical scan git-changes --staged --verbose --baseline-path .reports/secrets-report.json

# Run tests
echo "[husky]: Running script: pnpm test"
pnpm test
